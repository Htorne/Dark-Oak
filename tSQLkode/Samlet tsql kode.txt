/*
Create Master Card database for the Dreameater application.
*/

select 
*
into 
    MTGCardsDatabase -- Create this database
from 
    dbo.ImportCardDatabase a --With all the cards from the master database 
left join 
    dbo.ImportCardPrices b -- With all the cardprices from the 6 hour long data import 
	on a.mcmId= b.mcmid_b -- Join on the mcmID 


    /*
    Add card to database collection

    
    */

    
if exists (SELECT * FROM MTGCardsCollection WHERE scryfallId = '35c7c392-6782-40c8-bb24-6aad24f14660') --Lets check to see if the cards is present in the database
	begin
	declare @number_of_cards_in_collection as int
	set @number_of_cards_in_collection = (select amount_owned from MTGCardsCollection where scryfallId = '35c7c392-6782-40c8-bb24-6aad24f14660')
	set @number_of_cards_in_collection = @number_of_cards_in_collection + 1
	update MTGCardsCollection
	set amount_owned = @number_of_cards_in_collection
end
else
begin
	insert into MTGCardsCollection
	select *,1,0,'','',''  from MTGCardsDatabase 
	where scryfallId = '35c7c392-6782-40c8-bb24-6aad24f14660'
end



-------------------

DECLARE @sortboard int
DECLARE MY_CURSOR CURSOR 


LOCAL STATIC READ_ONLY FORWARD_ONLY
FOR 
SELECT DISTINCT sortboard 
FROM DarkOakDB.dbo.MTGCardsSortBoard
OPEN MY_CURSOR
FETCH NEXT FROM MY_CURSOR INTO @sortboard
WHILE @@FETCH_STATUS = 0
BEGIN 
DECLARE @number_of_cards_in_collection int	
DECLARE @scryfallid nvarchar(max)	
	set @scryfallid = (select scryfallid from DarkOakDB.dbo.MTGCardsSortBoard where sortboard = @sortboard)
	print  @scryfallid
		if exists (SELECT * FROM DarkOakDB.dbo.MTGCardsCollection WHERE scryfallId = @scryfallid ) --Lets check to see if the cards is present in the database
			begin
		
				set @number_of_cards_in_collection = (select amount_owned from DarkOakDB.dbo.MTGCardsCollection where scryfallId = @scryfallid)
	
				set @number_of_cards_in_collection = @number_of_cards_in_collection + 1
	
				update DarkOakDB.dbo.MTGCardsCollection set	amount_owned = @number_of_cards_in_collection where scryfallID = @scryfallid
			end
		else
	begin
				insert into DarkOakDB.dbo.MTGCardsCollection
		
				select *,1,0,'','','','',''  from DarkOakDB.dbo.MTGCardsDatabase 
			
				where scryfallId = @scryfallid
				print 'Just saw new card'
	end

	PRINT @sortboard
	FETCH NEXT FROM MY_CURSOR INTO @sortboard

end

CLOSE MY_CURSOR
DEALLOCATE MY_CURSOR
select [name],[amount_owned] from [DarkOakDB].[dbo].[MTGCardsCollection]

delete from [DarkOakDB].[dbo].[MTGCardsSortBoard]